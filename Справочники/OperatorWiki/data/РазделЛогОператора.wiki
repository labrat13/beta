++ Раздел Лог Оператора
[template: ШаблонСтраницыРазделаКонцепции]
Состояние: [//ДОПОЛНИТЬ] - уже реализована и добавлена в Оператор, хотя документация подсистемы лога не закончена.
    * я могу упустить что-то при настройке Оператора из-за того что тут не все устройство Лога описано.


+++Ссылки раздела
* ГлоссарийОператор


Разработана и внедрена в Оператор версия подсистемы лога.
Код протестирован на макете, добавлен в проект студии Оператор. Компилирован успешно, но не тестировался в сборе.

Лог используется для сбора статистики для Оператора. Поэтому лог должен вестись постоянно и при анализе восприниматься непрерывной последовательностью сообщений.

Лог также используется для накопления нераспознанных команд пользователя. Эти команды собираются в специальный файл, и используются для развития Оператор.

Для улучшения возможности анализа лога ведется также лог консоли - это запись диалогов с пользователем. 
 
Работа системы разделена на сеансы, и лог тоже разделен на сеансы. 
Сеансы могут длиться дольше суток. Предлагается использовать таймштамп начала сеанса в качестве имени сеанса лога и файлов лога.
Для анализа нужно представлять лог как единую последовательность сеансов с сообщениями.
Но чтобы хранить все сеансы, нужно выделить на них много дискового пространства.

Для работы с Логом пользователю потребуются [Команда]ы:
    * Записать в Лог - запись в лог сообщения от пользователя. 
    * Показать Лог - чтобы пользователь мог просмотреть лог
 
+++Описание устройства и работы подсистемы лога Оператора.
Лог состоит из трех типов файлов.
Все файлы одного формата, записаны в XML.

1) ФайлНераспознанныхКоманд - должен содержать только нераспознанные команды. Хранится в КаталогЛогаОператора. Размер не ограничен. Его назначение - накапливать нераспознанные команды пользователя для последующей статистической переработки и выделения новых команд.

2) ФайлЛогаКонсоли - должен содержать все сообщения, вводимые и выводимые на консоль. Хранится в КаталогСеансаЛога. Размер не ограничен. Его назначение - накапливать диалоги пользователя в течение сеанса для уточнения ситуаций и проблем в течение сеанса.

3) ФайлОбщегоЛога - должен содержать все сообщения лога. Хранится в КаталогСеансаЛога. Размер ограничен, лог разбивается на множество файлов. Его назначение - накапливать события в течение сеанса для уточнения ситуаций и проблем в течение сеанса.

Организация Сеансов лога была взята из проекта Тапп, в нее был добавлен собственный поток-исполнитель лога и поддержка 3 типов файлов лога. Енумератор лога и транзакции из Тапп в Операторе не нужны, поэтому устройство  лога получилось проще, чем в Тапп. Но и для автоматического разбора лог мало приспособлен.

+++Формат файла лога

++++Пример содержимого файла лога
<s>
  <row time="10.08.2018-12:33:55.250" code="НачалоСеанса" agent="Operator">Сеанс лога начат: 20180810-123355</row>
  <row time="10.08.2018-12:33:56.281" code="ВводКонсолиНеизвестнаяКоманда" agent="User">Команда пользователя</row>
  <row time="10.08.2018-12:33:56.750" code="ВводКонсолиНеизвестнаяКоманда" agent="User">Команда пользователя</row>
  <row time="10.08.2018-12:33:58.296" code="ЗавершениеСеанса" agent="Operator">Сеанс лога закончен: 20180810-123355</row>
</s>

++++Поля сообщения лога
* time - таймштамп сообщения, с точностью до миллисекунд.
* code - КлассСообщенияЛога - для разбора потока сообщений лога и разнесения в разные классы файлов лога. 
* agent - Агент-источник сообщения. Архитектура Оператор предполагает, что каждое задание исполняется отдельным  исполнителем. Исполнитель имеет имя, которое указывается здесь. Это позволяет разделять сообщения исполнителей в одном логе, где они перемешиваются.
* text - Содержание сообщения лога.

++++Описание
В течение сеанса лога файл лога может быть несколько раз закрыт и открыт. Каждый такой кусочек работы заключается в теги <s></s>.

В начале первого ФайлОбщегоЛога должно находиться сообщение с кодом "НачалоСеанса". 
Если файл не единственный, в его конце должно находиться сообщение с кодом "ПродолжениеСеанса".
В начале второго и последующих ФайлОбщегоЛога должно находиться сообщение с кодом "ПродолжениеСеанса".
В конце последнего или единственного ФайлОбщегоЛога должно находиться сообщение с кодом "ЗавершениеСеанса".

ФайлНераспознанныхКоманд не содержит сообщений о начале, конце или продолжени сеанса.

ФайлЛогаКонсоли в начале должен содержать сообщение с кодом "НачалоСеанса". 
В конце должно находиться сообщение с кодом "ЗавершениеСеанса".


+++КаналСообщенийЛога
Это event с помощью которого окно приложения может получать копии записываемых в лог сообщений лога.
Эти сообщения отправляются потоком-исполнителем лога, поэтому для их вывода в окно приложения надо разделять потоки.

+++Закрытие файлов лога по таймауту
В случае отсутствия сообщений лога более установленного времени (сейчас это 60 секунд), все файлы лога закрываются.
Открывается каждый файл самостоятельно, автоматически, при появлении записываемого в файл сообщения.
Таким образом, файлы лога при длительном простое будут закрыты. Не знаю, что в этом полезного - это эксперимент.

+++Быстрое закрытие файлов лога
Предполагается, что перед засыпанием можно будет закрыть все файлы лога.
Не знаю, что в этом полезного - это эксперимент.
Использовать функцию public void LogManager.CloseLogFilesTemporary().
Она использует механизм Закрытие файлов лога по таймауту, но закрывает файлы немедленно.

+++Многопоточность
Сообщения лога генерируются различными потоками. 
По приходу в подсистему лога они попадают в очередь команд потока-исполнителя лога.
Он и записывает сообщения в файлы. И вообще, выполняет всю работу в подсистеме лога.
Также, он отправляет копии сообщений через КаналСообщенийЛога подключенным получателям.
Другие команды управления логом тоже обрабатываются этим же потоком.
Таким образом, весь лог обрабатывается одним потоком, а остальные потоки изолированы от лога.


+++Контроль размера лога
* число файлов ФайлОбщегоЛога не должно быть более 999, поскольку номер файла входит в имя файла в виде трехсимвольного числа 000..999.
Можно увеличить это количество, переделав класс ФайлЛога и парсер имени файла в нем.
Я пока не знаю, имеет ли это смысл - все равно 999 файлов просмотреть мне будет не по силам.
* размер каждого файла ФайлОбщегоЛога должен находиться в пределах 1..2048 Мб. Рекомендуемый изначально 64Мб. 
  Общий максимальный размер файлов лога получится: 1 * 999 = 1Гб; 64 * 999 = 63Гб; 2048 * 999 = 1998Гб;
* общий размер каталога лога ограничен значением в файле настроек оператора.  Хотя реально он может несколько превышать установленный предел из-за того, что он не управляет файлами ФайлЛогаКонсоли и ФайлНераспознанныхКоманд.
Но по мере работы код управления размером лога пытается удержать его в заданных пределах, удаляя более старые сеансы лога.
* если нет более старых сеансов лога, кроме текущего, а пределы не позволяют создать новый файл, подсистема лога выбрасывает исключение. Это должно завершить Оператор.  
    

+++Материалы
